<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Portland Building Ages</title>
  <link rel="stylesheet" href="https://unpkg.com/maplibre-gl@4.0.0/dist/maplibre-gl.css" />
  <script src="https://unpkg.com/maplibre-gl@4.0.0/dist/maplibre-gl.js"></script>
  <script src="https://unpkg.com/pmtiles@3.0.6/dist/pmtiles.js"></script>
  <style>
    :root {
      --topbar-bg: #141414;
      --topbar-fg: rgba(255, 255, 255, 0.9);
      --topbar-muted: rgba(255, 255, 255, 0.65);
      --topbar-border: rgba(255, 255, 255, 0.08);
      --accent: #ff2fb3;
    }

    html,
    body {
      height: 100%;
      margin: 0;
    }

    body {
      font: 13px/1.25 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      background: #000;
      overflow: hidden;
    }

    #app {
      position: fixed;
      inset: 0;
      display: grid;
      grid-template-rows: calc(44px + env(safe-area-inset-top)) 1fr;
    }

    .topbar {
      grid-row: 1;
      display: flex;
      align-items: flex-end;
      justify-content: space-between;
      gap: 16px;
      padding: calc(env(safe-area-inset-top)) 16px 8px 16px;
      background: var(--topbar-bg);
      border-bottom: 1px solid var(--topbar-border);
      color: var(--topbar-fg);
      user-select: none;
    }

    .topbar-left {
      display: flex;
      align-items: baseline;
      gap: 10px;
      min-width: 0;
    }

    .brand {
      display: inline-flex;
      align-items: baseline;
      gap: 6px;
      font-weight: 700;
      letter-spacing: -0.02em;
      color: var(--topbar-fg);
      text-decoration: none;
      white-space: nowrap;
    }

    .brand-star {
      color: var(--accent);
      font-size: 12px;
      transform: translateY(-1px);
    }

    .page-title {
      color: var(--topbar-muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 70vw;
    }

    .topbar-right {
      display: flex;
      gap: 12px;
      align-items: center;
      color: var(--topbar-muted);
      font-size: 12px;
      white-space: nowrap;
    }

    .topbar-right a {
      color: inherit;
      text-decoration: none;
      border-bottom: 1px solid transparent;
    }

    .topbar-right a:hover {
      border-bottom-color: currentColor;
    }

    #map {
      grid-row: 2;
      position: relative;
      min-height: 0;
      width: 100%;
      height: 100%;
      background: #000;
    }

    .legend {
      position: absolute;
      right: 20px;
      bottom: 20px;
      z-index: 2;
      background: rgba(20, 20, 20, 0.86);
      color: rgba(255, 255, 255, 0.92);
      padding: 10px 12px;
      border-radius: 4px;
      border: 1px solid rgba(255, 255, 255, 0.12);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.25);
      backdrop-filter: blur(8px);
      max-width: min(360px, calc(100vw - 40px));
    }

    .legend-head {
      font-weight: 700;
      font-size: 11px;
      margin: 0 0 2px 0;
      color: rgba(255, 255, 255, 0.92);
    }

    .legend-title {
      font-weight: 700;
      font-size: 11px;
      margin: 0 0 6px 0;
      color: rgba(255, 255, 255, 0.9);
    }

    .legend-bar {
      height: 8px;
      border-radius: 2px;
      border: 1px solid rgba(255, 255, 255, 0.18);
      background: linear-gradient(90deg,
          #00d18f 0%,
          #00c7a8 18%,
          #00bcd4 36%,
          #0091ea 52%,
          #2962ff 68%,
          #6a5cff 82%,
          #ff2fb3 100%);
      margin: 0 0 6px 0;
    }

    .legend-labels {
      display: flex;
      justify-content: space-between;
      gap: 12px;
      font-size: 10px;
      color: rgba(255, 255, 255, 0.75);
      margin: 0 0 8px 0;
    }

    .legend-meta {
      font-size: 10px;
      color: rgba(255, 255, 255, 0.6);
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: space-between;
    }

    .maplibregl-popup-content {
      font: 12px/1.25 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    }
  </style>
</head>

<body>
  <div id="app">
    <header class="topbar" role="banner">
      <div class="topbar-left">
        <div class="page-title" title="Portland, Oregon: The Age of a City">Portland, Oregon: The Age of a City</div>
      </div>
      <nav class="topbar-right" aria-label="Links">
        <a href="../README.md">About</a>
      </nav>
    </header>

    <div id="map">
      <div class="legend" aria-label="Legend">
        <div class="legend-head">Portland, Oregon: The Age of a City</div>
        <div class="legend-title">Year Built</div>
        <div class="legend-bar" role="img" aria-label="Color scale from older to newer buildings"></div>
        <div class="legend-labels">
          <span>pre-1900</span>
          <span>2010+</span>
        </div>
        <div class="legend-meta">
          <span>Source: City of Portland</span>
          <span>Â© Justin Palmer, OSM contributors</span>
        </div>
      </div>
    </div>
  </div>
  <script>
    const useLocalPmtiles = true;
    const tilesUrl = useLocalPmtiles
      ? "pmtiles://http://localhost:8000/data/portland_buildings.pmtiles"
      : "https://tiles.yourdomain.com/portland_buildings/{z}/{x}/{y}.mvt";

    if (useLocalPmtiles) {
      const protocol = new pmtiles.Protocol();
      maplibregl.addProtocol("pmtiles", protocol.tile);
    }

    const buildingsSource = useLocalPmtiles
      ? {
        type: "vector",
        url: tilesUrl,
        maxzoom: 18,
      }
      : {
        type: "vector",
        tiles: [tilesUrl],
        maxzoom: 18,
      };

    const map = new maplibregl.Map({
      container: "map",
      center: [-122.676, 45.523],
      zoom: 13,
      maxZoom: 18,
      style: {
        version: 8,
        sources: {
          buildings: buildingsSource,
        },
        layers: [
          {
            id: "background",
            type: "background",
            paint: { "background-color": "#000" },
          },
          {
            id: "buildings-fill",
            type: "fill",
            source: "buildings",
            "source-layer": "buildings",
            paint: {
              "fill-color": [
                "match",
                ["get", "age_bucket"],
                "pre-1900",
                "#00d18f",
                "1900-1919",
                "#00c7a8",
                "1920-1944",
                "#00bcd4",
                "1945-1959",
                "#0091ea",
                "1960-1979",
                "#2962ff",
                "1980-1999",
                "#6a5cff",
                "2000-2009",
                "#a855f7",
                "2010-present",
                "#ff2fb3",
                "unknown",
                "#3a3a3a",
                "#3a3a3a",
              ],
              "fill-opacity": 0.9,
            },
          },
          {
            id: "buildings-outline",
            type: "line",
            source: "buildings",
            "source-layer": "buildings",
            paint: {
              "line-color": "#000",
              "line-width": 0.0,
              "line-opacity": 0.0,
            },
          },
        ],
      },
    });

    map.addControl(new maplibregl.NavigationControl({ showCompass: false }), "top-left");

    const popup = new maplibregl.Popup({
      closeButton: false,
      closeOnClick: false,
    });

    map.on("mousemove", "buildings-fill", (e) => {
      map.getCanvas().style.cursor = "pointer";
      const feature = e.features && e.features[0];
      if (!feature) return;
      const year = feature.properties?.year_built;
      const bucket = feature.properties?.age_bucket;
      popup
        .setLngLat(e.lngLat)
        .setHTML(
          `<strong>Year:</strong> ${year} <br/><strong>Bucket:</strong> ${bucket}`
        )
        .addTo(map);
    });

    map.on("mouseleave", "buildings-fill", () => {
      map.getCanvas().style.cursor = "";
      popup.remove();
    });

    // Optional continuous ramp:
    // map.setPaintProperty("buildings-fill", "fill-color", [
    //   "interpolate",
    //   ["linear"],
    //   ["get", "year_built"],
    //   1900, "#67001f",
    //   1940, "#d6604d",
    //   1970, "#fddbc7",
    //   2000, "#92c5de",
    //   2025, "#2166ac"
    // ]);
  </script>
</body>

</html>