<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Portland Building Ages</title>
  <link rel="stylesheet" href="https://unpkg.com/maplibre-gl@4.0.0/dist/maplibre-gl.css" />
  <script src="https://unpkg.com/maplibre-gl@4.0.0/dist/maplibre-gl.js"></script>
  <script src="https://unpkg.com/pmtiles@3.0.6/dist/pmtiles.js"></script>
  <style>
    html,
    body,
    #map {
      margin: 0;
      height: 100%;
    }

    .legend {
      position: absolute;
      bottom: 20px;
      left: 20px;
      background: #fff;
      padding: 10px 12px;
      border-radius: 6px;
      font: 12px/1.3 system-ui, -apple-system, sans-serif;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    }

    .legend .row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin: 4px 0;
    }

    .legend .swatch {
      width: 14px;
      height: 14px;
      border: 1px solid #333;
    }
  </style>
</head>

<body>
  <div id="map"></div>
  <div class="legend">
    <strong>Year Built</strong>
    <div class="row"><span class="swatch" style="background:#67001f"></span>pre-1900</div>
    <div class="row"><span class="swatch" style="background:#b2182b"></span>1900-1919</div>
    <div class="row"><span class="swatch" style="background:#d6604d"></span>1920-1944</div>
    <div class="row"><span class="swatch" style="background:#f4a582"></span>1945-1959</div>
    <div class="row"><span class="swatch" style="background:#fddbc7"></span>1960-1979</div>
    <div class="row"><span class="swatch" style="background:#d1e5f0"></span>1980-1999</div>
    <div class="row"><span class="swatch" style="background:#4393c3"></span>2000-2009</div>
    <div class="row"><span class="swatch" style="background:#2166ac"></span>2010-present</div>
    <div class="row"><span class="swatch" style="background:#808080"></span>unknown</div>
  </div>
  <script>
    const useLocalPmtiles = true;
    const tilesUrl = useLocalPmtiles
      ? "pmtiles://http://localhost:8000/data/portland_buildings.pmtiles"
      : "https://tiles.yourdomain.com/portland_buildings/{z}/{x}/{y}.mvt";

    if (useLocalPmtiles) {
      const protocol = new pmtiles.Protocol();
      maplibregl.addProtocol("pmtiles", protocol.tile);
    }

    const buildingsSource = useLocalPmtiles
      ? {
        type: "vector",
        url: tilesUrl,
        maxzoom: 15,
      }
      : {
        type: "vector",
        tiles: [tilesUrl],
        maxzoom: 15,
      };

    const map = new maplibregl.Map({
      container: "map",
      center: [-122.676, 45.523],
      zoom: 13,
      style: {
        version: 8,
        sources: {
          buildings: buildingsSource,
        },
        layers: [
          {
            id: "buildings-fill",
            type: "fill",
            source: "buildings",
            "source-layer": "buildings",
            paint: {
              "fill-color": [
                "match",
                ["get", "age_bucket"],
                "pre-1900",
                "#67001f",
                "1900-1919",
                "#b2182b",
                "1920-1944",
                "#d6604d",
                "1945-1959",
                "#f4a582",
                "1960-1979",
                "#fddbc7",
                "1980-1999",
                "#d1e5f0",
                "2000-2009",
                "#4393c3",
                "2010-present",
                "#2166ac",
                "unknown",
                "#808080",
                "#808080",
              ],
              "fill-opacity": 0.8,
            },
          },
          {
            id: "buildings-outline",
            type: "line",
            source: "buildings",
            "source-layer": "buildings",
            paint: {
              "line-color": "#333",
              "line-width": 0.3,
            },
          },
        ],
      },
    });

    const popup = new maplibregl.Popup({
      closeButton: false,
      closeOnClick: false,
    });

    map.on("mousemove", "buildings-fill", (e) => {
      map.getCanvas().style.cursor = "pointer";
      const feature = e.features && e.features[0];
      if (!feature) return;
      const year = feature.properties?.year_built;
      const bucket = feature.properties?.age_bucket;
      popup
        .setLngLat(e.lngLat)
        .setHTML(
          `<strong>Year:</strong> ${year} <br/><strong>Bucket:</strong> ${bucket}`
        )
        .addTo(map);
    });

    map.on("mouseleave", "buildings-fill", () => {
      map.getCanvas().style.cursor = "";
      popup.remove();
    });

    // Optional continuous ramp:
    // map.setPaintProperty("buildings-fill", "fill-color", [
    //   "interpolate",
    //   ["linear"],
    //   ["get", "year_built"],
    //   1900, "#67001f",
    //   1940, "#d6604d",
    //   1970, "#fddbc7",
    //   2000, "#92c5de",
    //   2025, "#2166ac"
    // ]);
  </script>
</body>

</html>